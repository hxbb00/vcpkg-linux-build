name: Install vcpkg

# 仅手动触发
on:
  workflow_dispatch:

jobs:
  build-gdal-linux:
    name: Build GDAL on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 安装系统级编译依赖
      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y build-essential cmake ninja-build curl zip unzip tar pkg-config libssl-dev

      # 1. Checkout vcpkg 官方仓库
      - name: Checkout vcpkg from GitHub
        uses: actions/checkout@v4
        with:
          repository: microsoft/vcpkg
          path: ${{ runner.workspace }}/vcpkg
          ref: master  # 可指定稳定版本 tag，如 2025.05.23

      # 2. Bootstrap 初始化 vcpkg（生成可执行文件）
      - name: Bootstrap vcpkg
        run: |
          cd ${{ runner.workspace }}/vcpkg
          ./bootstrap-vcpkg.sh -disableMetrics  # 关闭数据统计，加速初始化
          chmod +x ./vcpkg  # 确保可执行权限

      # 3. 安装带 PDAL 驱动的 GDAL
      - name: Install GDAL via vcpkg
        run: |
          ${{ runner.workspace }}/vcpkg/vcpkg install gdal[core,pdal] --triplet x64-linux
        shell: bash

      # 验证安装结果
      - name: Verify GDAL and LAS driver
        run: |
          export PATH="${{ runner.workspace }}/vcpkg/installed/x64-linux/bin:$PATH"
          # 检查 GDAL 版本
          gdalinfo --version
          # 检查 LAS 驱动
          gdalinfo --formats | grep -i LAS
          # 列出安装目录结构
          ls ${{ runner.workspace }}/vcpkg/installed/x64-linux
        shell: bash
