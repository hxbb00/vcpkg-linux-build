name: Install vcpkg

on:
  workflow_dispatch:

jobs:
  build-gdal-linux:
    name: Build GDAL on Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt update && sudo apt install -y build-essential cmake ninja-build curl zip unzip tar pkg-config libssl-dev autoconf autoconf-archive automake libtool

      # 关键修正：path 改为 github.workspace 下的相对路径
      - name: Checkout vcpkg from GitHub
        uses: actions/checkout@v4
        with:
          repository: microsoft/vcpkg
          path: vcpkg  # 会被解析为 ${github.workspace}/vcpkg
          ref: master

      - name: Bootstrap vcpkg
        run: |
          cd vcpkg
          ./bootstrap-vcpkg.sh -disableMetrics
          chmod +x ./vcpkg

      - name: Install GDAL via vcpkg
        run: |
          ./vcpkg/vcpkg install gdal --triplet x64-linux

      - name: Verify GDAL and LAS driver
        run: |
          export PATH="$PWD/vcpkg/installed/x64-linux/bin:$PATH"
          gdalinfo --version
          gdalinfo --formats | grep -i LAS
          ls $PWD/vcpkg/installed/x64-linux
        shell: bash
